{% extends "layout/base.html" %}

{% block title %}Detalhes do Caso - IntellexIA{% endblock %}

{% block content %}
<div class="app-content-header border-bottom border-light">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-sm-6">
        <h3 class="mb-0"><i class="bi bi-file-text text-primary"></i> Detalhes do Caso #{{ case.id }}</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end mb-0">
          <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}"><i class="bi bi-house"></i>
              Home</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('cases.cases_list') }}"><i class="bi bi-folder"></i> Casos</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page"><i class="bi bi-eye"></i> Detalhes</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        <!-- Informações do Caso -->
        <div class="card shadow-sm">
          <div class="card-header bg-gradient bg-primary text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-file-earmark-text"></i> Informações do Caso</h3>
            <div class="card-tools">
              <a href="{{ url_for('cases.case_edit', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-pencil"></i> Editar
              </a>
            </div>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="mb-3">
                  <small class="text-muted d-block"><i class="bi bi-tag"></i> Título</small>
                  <h5 class="mb-0 text-dark">{{ case.title }}</h5>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <small class="text-muted d-block"><i class="bi bi-person"></i> Cliente</small>
                  <h5 class="mb-0 text-dark">{{ case.client.name if case.client else 'Não informado' }}</h5>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <div class="mb-3">
                  <small class="text-muted d-block"><i class="bi bi-bookmark"></i> Tipo de Caso</small>
                  {% set case_type_map = {
                  'fap': 'Revisão FAP - AÇÃO REVISIONAL DO FATOR ACIDENTÁRIO DE PREVENÇÃO',
                  'previdenciario': 'Previdenciário',
                  'trabalhista': 'Trabalhista',
                  'outros': 'Outros'
                  } %}
                  {% if case.case_type %}
                  <span class="badge bg-primary">{{ case_type_map.get(case.case_type, case.case_type) }}</span>
                  {% else %}
                  <span class="text-muted">Não informado</span>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <small class="text-muted d-block"><i class="bi bi-shield-check"></i> Status</small>
                  {% set status_colors = {
                  'active': 'success',
                  'ativo': 'success',
                  'inactive': 'secondary',
                  'inativo': 'secondary',
                  'em_andamento': 'warning',
                  'in_progress': 'warning',
                  'concluido': 'info',
                  'completed': 'info',
                  'arquivado': 'danger',
                  'archived': 'danger'
                  } %}
                  {% if case.status %}
                  <span class="badge bg-{{ status_colors.get(case.status.lower(), 'secondary') }} p-2">
                    {% if case.status.lower() in ['ativo', 'active'] %}
                    <i class="bi bi-check-circle"></i> Ativo
                    {% elif case.status.lower() in ['em_andamento', 'in_progress'] %}
                    <i class="bi bi-hourglass-split"></i> Em Andamento
                    {% elif case.status.lower() in ['concluido', 'completed'] %}
                    <i class="bi bi-check-double"></i> Concluído
                    {% elif case.status.lower() in ['arquivado', 'archived'] %}
                    <i class="bi bi-archive"></i> Arquivado
                    {% elif case.status.lower() in ['inativo', 'inactive'] %}
                    <i class="bi bi-x-circle"></i> Inativo
                    {% else %}
                    {{ case.status }}
                    {% endif %}
                  </span>
                  {% else %}
                  <span class="text-muted">Não informado</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Nota: Motivo/Enquadramento FAP agora é exibido em cada benefício -->

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <small class="text-muted d-block"><i class="bi bi-cash-coin"></i> Valor da Causa</small>
                  {% if case.value_cause %}
                  <h6 class="mb-0 text-success">R$ {{ "{:,.2f}".format(case.value_cause).replace(',', 'X').replace('.',
                    ',').replace('X', '.') }}</h6>
                  {% else %}
                  <span class="text-muted">Não informado</span>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <small class="text-muted d-block"><i class="bi bi-calendar-event"></i> Data de Ajuizamento</small>
                  {% if case.filing_date %}
                  <h6 class="mb-0">{{ case.filing_date.strftime('%d/%m/%Y') }}</h6>
                  {% else %}
                  <span class="text-muted">Não informada</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumos -->
        <div class="card shadow-sm mt-4">
          <div class="card-header bg-gradient bg-info text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-chat-left-text"></i> Resumos</h3>
          </div>
          <div class="card-body">
            <div class="mb-4">
              <h6 class="text-primary mb-2"><i class="bi bi-bookmark-star"></i> Resumo dos Fatos</h6>
              {% if case.facts_summary %}
              <div class="mb-0">{{ case.facts_summary|safe }}</div>
              {% else %}
              <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Nenhum resumo cadastrado ainda.</p>
              {% endif %}
            </div>

            <hr class="my-3">

            <div class="mb-4">
              <h6 class="text-primary mb-2"><i class="bi bi-scales"></i> Teses Jurídicas</h6>
              {% if case.thesis_summary %}
              <div class="mb-0">{{ case.thesis_summary|safe }}</div>
              {% else %}
              <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Nenhuma tese cadastrada ainda.</p>
              {% endif %}
            </div>

            <hr class="my-3">

            <div>
              <h6 class="text-primary mb-2"><i class="bi bi-calendar-check"></i> Informações sobre Prescrição</h6>
              {% if case.prescription_summary %}
              <div class="mb-0">{{ case.prescription_summary|safe }}</div>
              {% else %}
              <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> Nenhuma informação cadastrada ainda.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Benefícios -->
        <div class="card shadow-sm mt-4">
          <div class="card-header bg-gradient bg-success text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-briefcase"></i> Benefícios</h3>
            <div class="card-tools">
              <a href="{{ url_for('benefits.case_benefits_list', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-eye"></i> Ver Todos
              </a>
              <a href="{{ url_for('benefits.case_benefit_new', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-plus-circle"></i> Adicionar
              </a>
            </div>
          </div>
          <div class="card-body">
            {% if benefits %}
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th><i class="bi bi-hash"></i> NB</th>
                    <th><i class="bi bi-tag"></i> Tipo</th>
                    <th><i class="bi bi-person"></i> Segurado</th>
                    <th><i class="bi bi-info-circle"></i> Motivo FAP</th>
                    <th><i class="bi bi-calendar"></i> Data Acidente</th>
                    <th><i class="bi bi-calendar-range"></i> Vigências FAP</th>
                    <th><i class="bi bi-gear"></i> Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% set fap_reason_map = {
                    'inclusao_indevida_trajeto': 'Inclusão indevida',
                    'erro_material_cat': 'Erro material CAT',
                    'cat_trajeto_extemporanea': 'CAT extemporânea'
                  } %}
                  {% for benefit in benefits[:3] %}
                  <tr>
                    <td><strong>{{ benefit.benefit_number }}</strong></td>
                    <td><span class="badge bg-light text-dark">{{ benefit.benefit_type }}</span></td>
                    <td>{{ benefit.insured_name }}</td>
                    <td>
                      {% if benefit.fap_reason_obj %}
                      <span class="badge bg-info">{{ benefit.fap_reason_obj.display_name }}</span>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td><small>{{ benefit.accident_date.strftime('%d/%m/%Y') if benefit.accident_date else '-'
                        }}</small></td>
                    <td>
                      {% if benefit.fap_vigencia_years %}
                      <span class="badge bg-warning text-dark">
                        {% for year in benefit.fap_vigencia_years.split(',') %}
                          {{ year }}{% if not loop.last %}<br>{% endif %}
                        {% endfor %}
                      </span>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#benefitModal{{ benefit.id }}" title="Visualizar detalhes">
                        <i class="bi bi-eye"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if benefits|length > 3 %}
            <div class="text-center mt-2">
              <a href="{{ url_for('benefits.case_benefits_list', case_id=case_id) }}"
                class="btn btn-sm btn-outline-success">
                <i class="bi bi-eye"></i> Ver todos os {{ benefits|length }} benefícios
              </a>
            </div>
            {% endif %}
            {% else %}
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> Nenhum benefício cadastrado ainda.
              <a href="{{ url_for('benefits.case_benefit_new', case_id=case_id) }}"
                class="btn btn-outline-success btn-sm ms-2">
                <i class="bi bi-plus-circle"></i> Adicionar primeiro benefício
              </a>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Modais de Benefícios -->
        {% for benefit in benefits[:3] %}
        <div class="modal fade" id="benefitModal{{ benefit.id }}" tabindex="-1"
          aria-labelledby="benefitModalLabel{{ benefit.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="benefitModalLabel{{ benefit.id }}">
                  <i class="bi bi-briefcase"></i> Benefício #{{ benefit.benefit_number }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-tag"></i> Número do Benefício</small>
                    <h6>{{ benefit.benefit_number }}</h6>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-bookmark"></i> Tipo</small>
                    <h6><span class="badge bg-light text-dark">{{ benefit.benefit_type }}</span></h6>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-person"></i> Nome do Segurado</small>
                    <h6>{{ benefit.insured_name }}</h6>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-card-text"></i> NIT/PIS</small>
                    <h6>{{ benefit.insured_nit or '-' }}</h6>
                  </div>
                </div>

                <hr class="my-3">

                <h6 class="text-primary mb-3"><i class="bi bi-exclamation-triangle-fill"></i> Informações do Acidente</h6>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-calendar"></i> Data do Acidente</small>
                    <h6>{{ benefit.accident_date.strftime('%d/%m/%Y') if benefit.accident_date else '-' }}</h6>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-building"></i> Empresa</small>
                    <h6>{{ benefit.accident_company_name or '-' }}</h6>
                  </div>
                </div>

                {% if benefit.accident_summary %}
                <div class="row mb-3">
                  <div class="col-md-12">
                    <small class="text-muted"><i class="bi bi-file-text"></i> Resumo do Acidente</small>
                    <p class="text-muted mb-0" style="white-space: pre-wrap;">{{ benefit.accident_summary }}</p>
                  </div>
                </div>
                {% endif %}

                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-file-text"></i> Número da CAT</small>
                    <h6>{{ benefit.numero_cat or '-' }}</h6>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-file-text"></i> Número do BO</small>
                    <h6>{{ benefit.numero_bo or '-' }}</h6>
                  </div>
                </div>

                <hr class="my-3">

                <h6 class="text-primary mb-3"><i class="bi bi-gift-fill"></i> Informações do Benefício</h6>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-calendar-check"></i> Data de Início</small>
                    <h6>{{ benefit.data_inicio_beneficio.strftime('%d/%m/%Y') if benefit.data_inicio_beneficio else '-'
                      }}</h6>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-calendar-x"></i> Data de Fim</small>
                    <h6>{{ benefit.data_fim_beneficio.strftime('%d/%m/%Y') if benefit.data_fim_beneficio else '-' }}</h6>
                  </div>
                </div>

                <hr class="my-3">

                <h6 class="text-primary mb-3"><i class="bi bi-shield-check"></i> Informações da Contestação FAP</h6>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-info-circle"></i> Motivo da Contestação</small>
                    <h6>
                      {% if benefit.fap_reason_obj %}
                      <span class="badge bg-info">{{ benefit.fap_reason_obj.display_name }}</span>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </h6>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted"><i class="bi bi-calendar-range"></i> Vigências FAP</small>
                    <h6>
                      {% if benefit.fap_vigencia_years %}
                      <span class="badge bg-warning text-dark">
                        {% for year in benefit.fap_vigencia_years.split(',') %}
                          {{ year }}{% if not loop.last %},&nbsp;{% endif %}
                        {% endfor %}
                      </span>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </h6>
                  </div>
                </div>

                {% if benefit.notes %}
                <hr class="my-3">
                <h6 class="text-primary mb-3"><i class="bi bi-chat-left-text"></i> Observações</h6>
                <p class="text-muted mb-0">{{ benefit.notes }}</p>
                {% endif %}
              </div>
              <div class="modal-footer">
                <a href="{{ url_for('benefits.case_benefit_edit', case_id=case.id, benefit_id=benefit.id) }}"
                  class="btn btn-sm btn-primary">
                  <i class="bi bi-pencil"></i> Editar
                </a>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle"></i> Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}

        <!-- Documentos -->
        <div class="card shadow-sm mt-4">
          <div class="card-header bg-gradient bg-warning text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-file-earmark-pdf"></i> Documentos</h3>
            <div class="card-tools">
              <a href="{{ url_for('documents.case_documents_list', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-eye"></i> Ver Todos
              </a>
              <a href="{{ url_for('documents.case_document_new', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-upload"></i> Upload
              </a>
            </div>
          </div>
          <div class="card-body">
            {% if documents %}
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th><i class="bi bi-file-text"></i> Arquivo</th>
                    <th><i class="bi bi-tag"></i> Tipo</th>
                    <th><i class="bi bi-calendar"></i> Upload</th>
                  </tr>
                </thead>
                <tbody>
                  {% for doc in documents[:3] %}
                  <tr>
                    <td>
                      <i class="bi bi-file-earmark-pdf text-danger"></i>
                      {{ doc.original_filename[:25] }}{% if doc.original_filename|length > 25 %}...{% endif %}
                    </td>
                    <td>
                      {% if doc.document_type == 'cat' %}
                      <span class="badge bg-danger">CAT</span>
                      {% elif doc.document_type == 'laudo_medico' %}
                      <span class="badge bg-info">Laudo</span>
                      {% elif doc.document_type == 'infben' %}
                      <span class="badge bg-primary">INFBEN</span>
                      {% else %}
                      <span class="badge bg-secondary">{{ doc.document_type[:6] }}</span>
                      {% endif %}
                    </td>
                    <td><small class="text-muted">{{ doc.uploaded_at.strftime('%d/%m/%Y') if doc.uploaded_at else '-'
                        }}</small></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if documents|length > 3 %}
            <div class="text-center mt-2">
              <a href="{{ url_for('documents.case_documents_list', case_id=case_id) }}"
                class="btn btn-sm btn-outline-warning">
                <i class="bi bi-eye"></i> Ver todos os {{ documents|length }} documentos
              </a>
            </div>
            {% endif %}
            {% else %}
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> Nenhum documento anexado ainda.
              <a href="{{ url_for('documents.case_document_new', case_id=case_id) }}"
                class="btn btn-outline-success btn-sm ms-2">
                <i class="bi bi-upload"></i> Enviar primeiro documento
              </a>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Petições Geradas com IA -->
        <div class="card shadow-sm mt-4">
          <div class="card-header bg-gradient bg-danger text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-robot"></i> Petições Geradas com IA</h3>
            <div class="card-tools">
              {% if petitions %}
              <a href="{{ url_for('petitions.case_petitions_list', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-eye"></i> Ver Todas
              </a>
              {% endif %}
              <a href="{{ url_for('petitions.case_petition_generate', case_id=case_id) }}" class="btn btn-sm btn-light">
                <i class="bi bi-magic"></i> Gerar Nova
              </a>
            </div>
          </div>
          <div class="card-body">
            {% if petitions %}
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th><i class="bi bi-tag"></i> Versão</th>
                    <th><i class="bi bi-file-text"></i> Título</th>
                    <th><i class="bi bi-calendar"></i> Gerada em</th>
                    <th><i class="bi bi-circle-fill"></i> Status</th>
                    <th><i class="bi bi-gear"></i> Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for petition in petitions[:3] %}
                  <tr>
                    <td><span class="badge bg-primary">v{{ petition.version }}</span></td>
                    <td>{{ petition.title[:35] }}{% if petition.title|length > 35 %}...{% endif %}</td>
                    <td><small class="text-muted">{{ petition.generated_at.strftime('%d/%m/%Y %H:%M') if
                        petition.generated_at else '-' }}</small></td>
                    <td>
                      {% if petition.status == 'completed' %}
                      <span class="badge bg-success"><i class="bi bi-check-circle"></i> Concluída</span>
                      {% elif petition.status == 'processing' %}
                      <span class="badge bg-info"><i class="bi bi-hourglass-split"></i> Processando</span>
                      {% elif petition.status == 'error' %}
                      <span class="badge bg-danger"><i class="bi bi-exclamation-circle"></i> Erro</span>
                      {% else %}
                      <span class="badge bg-secondary">{{ petition.status }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <a href="{{ url_for('petitions.case_petition_view', case_id=case_id, petition_id=petition.id) }}"
                        class="btn btn-sm btn-outline-info" title="Visualizar">
                        <i class="bi bi-eye"></i>
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if petitions|length > 3 %}
            <div class="text-center mt-2">
              <a href="{{ url_for('petitions.case_petitions_list', case_id=case_id) }}"
                class="btn btn-sm btn-outline-danger">
                <i class="bi bi-eye"></i> Ver todas as {{ petitions|length }} petições
              </a>
            </div>
            {% endif %}
            {% else %}
            <div class="alert alert-warning mb-0">
              <i class="bi bi-stars"></i> Nenhuma petição gerada ainda.
              <a href="{{ url_for('petitions.case_petition_generate', case_id=case_id) }}"
                class="btn btn-outline-warning btn-sm ms-2">
                <i class="bi bi-magic"></i> Gerar primeira petição com IA
              </a>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Comentários/Discussões -->
        {% include 'cases/comments_section.html' %}
      </div>

      <div class="col-md-4">
        <!-- Ações Rápidas -->
        <div class="card shadow-sm">
          <div class="card-header bg-gradient bg-primary text-white border-0">
            <h3 class="card-title mb-0">
              <i class="bi bi-lightning-charge"></i> Ações Rápidas
            </h3>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a href="{{ url_for('documents.case_documents_list', case_id=case_id) }}"
                class="btn btn-sm btn-outline-primary">
                <i class="bi bi-file-earmark-text"></i> Gerenciar Documentos
              </a>
              <a href="{{ url_for('documents.case_document_new', case_id=case_id) }}"
                class="btn btn-sm btn-outline-success">
                <i class="bi bi-upload"></i> Upload Documento
              </a>
              <a href="{{ url_for('benefits.case_benefit_new', case_id=case_id) }}" class="btn btn-sm btn-outline-info">
                <i class="bi bi-plus-circle"></i> Adicionar Benefício
              </a>
              <a href="{{ url_for('petitions.case_petition_generate', case_id=case_id) }}"
                class="btn btn-sm btn-outline-danger">
                <i class="bi bi-robot"></i> Gerar Petição com IA
              </a>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openActivityTimeline()">
                <i class="bi bi-clock-history"></i> Histórico
              </button>
            </div>
          </div>
        </div>

        <!-- Advogados -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-gradient bg-secondary text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-person-check"></i> Advogados do Caso</h3>
            <div class="card-tools">
              <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addLawyerModal">
                <i class="bi bi-plus-circle"></i> Adicionar
              </button>
            </div>
          </div>
          <div class="card-body">
            {% if case_lawyers %}
            <div class="list-group list-group-flush">
              {% for case_lawyer in case_lawyers %}
              <div class="list-group-item px-0 d-flex justify-content-between align-items-center border-bottom">
                <div>
                  <h6 class="mb-1">
                    <i class="bi bi-person-badge text-primary"></i> {{ case_lawyer.lawyer.name }}
                  </h6>
                  <small class="text-muted">
                    OAB: {{ case_lawyer.lawyer.oab_number }}
                    {% if case_lawyer.role %}
                    | Função: {{ case_lawyer.role }}
                    {% endif %}
                  </small>
                  {% if case_lawyer.lawyer.email %}
                  <br><small class="text-muted"><i class="bi bi-envelope"></i> {{ case_lawyer.lawyer.email
                    }}</small>
                  {% endif %}
                </div>
                <form action="{{ url_for('cases.case_lawyer_remove', case_id=case_id, case_lawyer_id=case_lawyer.id) }}"
                  method="POST" style="display: inline;"
                  onsubmit="return confirm('Tem certeza que deseja remover este advogado do caso?');">
                  <button type="submit" class="btn btn-sm btn-danger" title="Remover">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> Nenhum advogado vinculado ainda.
              <button class="btn btn-outline-primary btn-sm ms-2" data-bs-toggle="modal"
                data-bs-target="#addLawyerModal">
                <i class="bi bi-plus-circle"></i> Adicionar primeiro advogado
              </button>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Modal para Adicionar Advogado -->
        <div class="modal fade" id="addLawyerModal" tabindex="-1" aria-labelledby="addLawyerModalLabel"
          aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addLawyerModalLabel">
                  <i class="bi bi-person-plus"></i> Adicionar Advogado ao Caso
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form action="{{ url_for('cases.case_lawyer_add', case_id=case_id) }}" method="POST">
                <div class="modal-body">
                  {% if all_lawyers %}
                  <div class="mb-3">
                    <label for="lawyer_id" class="form-label">Selecione o Advogado <span
                        class="text-danger">*</span></label>
                    <select name="lawyer_id" id="lawyer_id" class="form-select" required>
                      <option value="">-- Selecione --</option>
                      {% for lawyer in all_lawyers %}
                      <option value="{{ lawyer.id }}">{{ lawyer.name }} (OAB: {{ lawyer.oab_number }})</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="mb-3">
                    <label for="role" class="form-label">Função/Papel no Caso</label>
                    <input type="text" name="role" id="role" class="form-control"
                      placeholder="Ex: Responsável, Publicações, etc.">
                    <div class="form-text">Opcional: Defina a função deste advogado no caso</div>
                  </div>
                  {% else %}
                  <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Nenhum advogado cadastrado no sistema.
                    <a href="{{ url_for('lawyers.lawyer_new') }}" class="btn btn-outline-primary btn-sm ms-2"
                      target="_blank">
                      <i class="bi bi-plus-circle"></i> Cadastrar Advogado
                    </a>
                  </div>
                  {% endif %}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                  </button>
                  {% if all_lawyers %}
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Adicionar Advogado
                  </button>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Vara Judicial -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-gradient bg-teal text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-scales"></i> Vara Judicial</h3>
          </div>
          <div class="card-body">
            {% if case.court %}
            <div class="mb-3">
              <small class="text-muted d-block"><i class="bi bi-building"></i> Vara</small>
              <h6 class="mb-0">{{ case.court.vara_name }}</h6>
            </div>
            <div class="mb-3">
              <small class="text-muted d-block"><i class="bi bi-folder-check"></i> Seção</small>
              <h6 class="mb-0">{{ case.court.section or 'Não informado' }}</h6>
            </div>
            <div>
              <small class="text-muted d-block"><i class="bi bi-geo-alt"></i> Localização</small>
              <h6 class="mb-0">{{ case.court.city }}/{{ case.court.state }}</h6>
            </div>
            {% else %}
            <div class="alert alert-warning mb-0">
              <i class="bi bi-exclamation-triangle"></i> Nenhuma vara selecionada para este caso.
              <a href="{{ url_for('cases.case_edit', case_id=case_id) }}" class="btn btn-outline-primary btn-sm ms-2">
                <i class="bi bi-pencil"></i> Editar caso
              </a>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Estatísticas -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-gradient bg-success text-white border-0">
            <h3 class="card-title mb-0"><i class="bi bi-graph-up"></i> Resumo</h3>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="text-center p-3 bg-light border-start border-primary border-4">
                  <h4 class="mb-1 text-primary"><i class="bi bi-file-earmark"></i> {{ documents|length }}</h4>
                  <small class="text-muted">Documentos</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center p-3 bg-light border-start border-success border-4">
                  <h4 class="mb-1 text-success"><i class="bi bi-briefcase"></i> {{ benefits|length }}</h4>
                  <small class="text-muted">Benefícios</small>
                </div>
              </div>
            </div>
            {% if petitions %}
            <div class="mt-3 pt-3 border-top">
              <small class="text-muted d-block mb-2"><i class="bi bi-robot"></i> Petições Geradas</small>
              <h5 class="mb-0 text-danger">{{ petitions|length }}</h5>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Timeline de Atividades -->
{% include 'cases/activity_timeline_modal.html' %}
{% endblock %}