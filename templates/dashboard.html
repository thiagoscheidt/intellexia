{% extends 'layout/base.html' %}

{% block title %}Dashboard do Sistema{% endblock %}
{% block page_title %}Dashboard do Sistema{% endblock %}

{% block content %}
<!-- Verificação se há dados -->
<div class="alert alert-info">
  <h4><i class="bi bi-info-circle me-2"></i>Status do Sistema</h4>
  <p>Dashboard carregado com sucesso! Este é o painel de controle do sistema Intellexia.</p>
</div>

<!-- Cards de Métricas Principais -->
<div class="row">
  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-primary">
      <div class="inner">
        <h3>{{ total_cases or 0 }}</h3>
        <p>Total de Casos</p>
      </div>
      <div class="small-box-icon">
        <i class="bi bi-briefcase-fill"></i>
      </div>
      <a href="{{ url_for('cases.cases_list') }}" class="small-box-footer">
        Ver todos <i class="bi bi-arrow-right-circle-fill"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-success">
      <div class="inner">
        <h3>{{ active_cases or 0 }}</h3>
        <p>Casos Ativos</p>
      </div>
      <div class="small-box-icon">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <a href="{{ url_for('cases.cases_list') }}" class="small-box-footer">
        Ver ativos <i class="bi bi-arrow-right-circle-fill"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-warning">
      <div class="inner">
        <h3>{{ total_clients or 0 }}</h3>
        <p>Clientes</p>
      </div>
      <div class="small-box-icon">
        <i class="bi bi-people-fill"></i>
      </div>
      <a href="{{ url_for('clients.clients_list') }}" class="small-box-footer">
        Ver clientes <i class="bi bi-arrow-right-circle-fill"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-info">
      <div class="inner">
        <h3>{{ total_benefits or 0 }}</h3>
        <p>Benefícios</p>
      </div>
      <div class="small-box-icon">
        <i class="bi bi-shield-check-fill"></i>
      </div>
      <a href="{{ url_for('benefits.benefits_list') }}" class="small-box-footer">
        Ver benefícios <i class="bi bi-arrow-right-circle-fill"></i>
      </a>
    </div>
  </div>
</div>

<!-- Indicadores de saúde do pipeline -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-activity me-1"></i>
          Taxa de Ativos
        </h3>
      </div>
      <div class="card-body">
        {% set total_cases_safe = total_cases or 0 %}
        {% set active_pct = total_cases_safe and ((active_cases or 0) * 100 / total_cases_safe) or 0 %}
        <div class="d-flex align-items-center mb-2">
          <strong class="me-2">{{ active_cases or 0 }}</strong>
          <span class="text-muted">de {{ total_cases_safe }} casos</span>
          <span class="ms-auto text-success fw-bold">{{ '%.0f'|format(active_pct) }}%</span>
        </div>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-success" role="progressbar" style="width: {{ active_pct }}%;"
            aria-valuenow="{{ active_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-journal-check me-1"></i>
          Taxa de Protocolados
        </h3>
      </div>
      <div class="card-body">
        {% set filed_pct = total_cases_safe and ((filed_cases or 0) * 100 / total_cases_safe) or 0 %}
        <div class="d-flex align-items-center mb-2">
          <strong class="me-2">{{ filed_cases or 0 }}</strong>
          <span class="text-muted">de {{ total_cases_safe }} casos</span>
          <span class="ms-auto text-primary fw-bold">{{ '%.0f'|format(filed_pct) }}%</span>
        </div>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-primary" role="progressbar" style="width: {{ filed_pct }}%;"
            aria-valuenow="{{ filed_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Informações detalhadas em cards -->
<div class="row">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-pie-chart me-1"></i>
          Estatísticas de Casos
        </h3>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-8">Total de Casos:</dt>
          <dd class="col-sm-4"><span class="badge bg-primary">{{ total_cases or 0 }}</span></dd>

          <dt class="col-sm-8">Casos Ativos:</dt>
          <dd class="col-sm-4"><span class="badge bg-success">{{ active_cases or 0 }}</span></dd>

          <dt class="col-sm-8">Rascunhos:</dt>
          <dd class="col-sm-4"><span class="badge bg-warning">{{ draft_cases or 0 }}</span></dd>

          <dt class="col-sm-8">Casos Protocolados:</dt>
          <dd class="col-sm-4"><span class="badge bg-info">{{ filed_cases or 0 }}</span></dd>
        </dl>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-people me-1"></i>
          Estatísticas Gerais
        </h3>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-8">Total de Clientes:</dt>
          <dd class="col-sm-4"><span class="badge bg-primary">{{ total_clients or 0 }}</span></dd>

          <dt class="col-sm-8">Total de Advogados:</dt>
          <dd class="col-sm-4"><span class="badge bg-secondary">{{ total_lawyers or 0 }}</span></dd>

          <dt class="col-sm-8">Total de Benefícios:</dt>
          <dd class="col-sm-4"><span class="badge bg-info">{{ total_benefits or 0 }}</span></dd>

          <dt class="col-sm-8">Total de Documentos:</dt>
          <dd class="col-sm-4"><span class="badge bg-warning">{{ total_documents or 0 }}</span></dd>
        </dl>
      </div>
    </div>
  </div>
</div>

<!-- Valor total e distribuições -->
<div class="row mt-3">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-clock-history me-1"></i>
          Casos Recentes
        </h3>
      </div>
      <div class="card-body">
        {% if recent_cases and recent_cases|length > 0 %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Título</th>
                <th>Cliente</th>
                <th>Status</th>
                <th>Criado em</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for case in recent_cases %}
              <tr>
                <td>
                  <strong>{{ case.title[:40] }}{% if case.title|length > 40 %}...{% endif %}</strong>
                </td>
                <td>{{ case.client.name[:25] if case.client else 'N/A' }}{% if case.client and case.client.name|length >
                  25 %}...{% endif %}</td>
                <td>
                  {% if case.status == 'active' %}
                  <span class="badge bg-success">Ativo</span>
                  {% elif case.status == 'draft' %}
                  <span class="badge bg-warning">Rascunho</span>
                  {% else %}
                  <span class="badge bg-secondary">{{ case.status|title }}</span>
                  {% endif %}
                </td>
                <td>{{ case.created_at.strftime('%d/%m/%Y') if case.created_at else '-' }}</td>
                <td>
                  <a href="{{ url_for('cases.case_detail', case_id=case.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">
          <p class="mb-0">Nenhum caso encontrado. <a href="{{ url_for('cases.case_new') }}">Criar primeiro caso</a></p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-lightning-charge me-1"></i>
          Ações Rápidas
        </h3>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('cases.case_new') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Novo Caso
          </a>
          <a href="{{ url_for('assistant.legal_assistant') }}" class="btn btn-success">
            <i class="bi bi-robot me-2"></i>Assistente Jurídico
          </a>
          <a href="{{ url_for('clients.client_new') }}" class="btn btn-outline-primary">
            <i class="bi bi-building-add me-2"></i>Novo Cliente
          </a>
          <a href="{{ url_for('lawyers.lawyer_new') }}" class="btn btn-outline-secondary">
            <i class="bi bi-person-plus me-2"></i>Novo Advogado
          </a>
          <hr>
          <a href="{{ url_for('cases.cases_list') }}" class="btn btn-light">
            <i class="bi bi-list-ul me-2"></i>Todos os Casos
          </a>
          <a href="{{ url_for('clients.clients_list') }}" class="btn btn-light">
            <i class="bi bi-people me-2"></i>Todos os Clientes
          </a>
        </div>
      </div>
    </div>

    {% if total_cause_value and total_cause_value > 0 %}
    <div class="card mt-3">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-currency-dollar me-1"></i>
          Valor Total das Causas
        </h3>
      </div>
      <div class="card-body text-center">
        <h4 class="text-primary">
          R$ {{ "{:,.2f}".format(total_cause_value).replace(",", "X").replace(".", ",").replace("X", ".") }}
        </h4>
        <small class="text-muted">Soma de todos os valores de causa</small>
      </div>
    </div>
    {% endif %}

    <div class="card mt-3">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-bar-chart me-1"></i>
          Distribuições
        </h3>
      </div>
      <div class="card-body">
        {% if cases_by_type %}
        <h6>Por Tipo de Caso:</h6>
        <ul class="list-unstyled">
          {% for case_type, count in cases_by_type.items() %}
          <li>
            <span class="badge bg-secondary me-2">{{ count }}</span>
            {% if case_type == 'fap_trajeto' %}
            FAP Trajeto
            {% elif case_type == 'fap_nexo' %}
            FAP Nexo
            {% elif case_type == 'fap_multiplos' %}
            FAP Múltiplos
            {% elif case_type == 'auto_infracao' %}
            Auto Infração
            {% else %}
            {{ case_type|title }}
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% endif %}

        {% if cases_by_status %}
        <h6 class="mt-3">Por Status:</h6>
        <ul class="list-unstyled">
          {% for status, count in cases_by_status.items() %}
          <li>
            {% if status == 'active' %}
            <span class="badge bg-success me-2">{{ count }}</span> Ativos
            {% elif status == 'draft' %}
            <span class="badge bg-warning me-2">{{ count }}</span> Rascunhos
            {% else %}
            <span class="badge bg-secondary me-2">{{ count }}</span> {{ status|title }}
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Gráficos rápidos (fim da página) -->
<div class="row mt-3">
  <div class="col-lg-6">
    <div class="card card-outline card-primary h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0"><i class="bi bi-graph-up-arrow me-1"></i> Casos por Status</h3>
        <span class="badge bg-primary">Visão geral</span>
      </div>
      <div class="card-body">
        {% if cases_by_status %}
        <canvas id="chartStatus" height="160"></canvas>
        {% else %}
        <div class="alert alert-light mb-0">Sem dados de status para exibir.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card card-outline card-info h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0"><i class="bi bi-pie-chart me-1"></i> Casos por Tipo</h3>
        <span class="badge bg-info">Distribuição</span>
      </div>
      <div class="card-body">
        {% if cases_by_type %}
        <canvas id="chartType" height="160"></canvas>
        {% else %}
        <div class="alert alert-light mb-0">Sem dados de tipos para exibir.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Série temporal: casos abertos mês a mês -->
<div class="row mt-3">
  <div class="col-12">
    <div class="card card-outline card-secondary h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0"><i class="bi bi-calendar3 me-1"></i> Casos Abertos por Mês</h3>
        <span class="badge bg-secondary">Últimos meses</span>
      </div>
      <div class="card-body">
        {% if cases_by_month %}
        <canvas id="chartMonthly" height="180"></canvas>
        {% else %}
        <div class="alert alert-light mb-0">Sem dados mensais para exibir.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Sessão: Base de Conhecimento do Escritório -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-0 shadow-lg" style="border-radius: 15px; overflow: hidden;">
      <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.2rem;">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <div class="rounded-circle bg-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
              <i class="bi bi-book-fill" style="font-size: 1.2rem; color: #667eea;"></i>
            </div>
          </div>
          <div>
            <h3 class="card-title mb-0" style="font-weight: 600; font-size: 1.1rem;">Base de Conhecimento do Escritório</h3>
            <small class="opacity-75">Resumo dos documentos, categorias e tags cadastrados</small>
          </div>
        </div>
      </div>
      <div class="card-body" style="padding: 1.5rem;">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <span class="badge bg-primary" style="font-size: 1.2rem; padding: 12px 16px; border-radius: 50%;">
                  <i class="bi bi-collection-fill"></i>
                </span>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700;">{{ knowledge_count or 0 }}</div>
                <div class="text-muted">Documentos</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <span class="badge bg-warning text-dark" style="font-size: 1.2rem; padding: 12px 16px; border-radius: 50%;">
                  <i class="bi bi-folder-fill"></i>
                </span>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700;">{{ knowledge_categories_count or 0 }}</div>
                <div class="text-muted">Categorias</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center">
              <div class="me-3">
                <span class="badge bg-success" style="font-size: 1.2rem; padding: 12px 16px; border-radius: 50%;">
                  <i class="bi bi-tags-fill"></i>
                </span>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700;">{{ knowledge_tags_count or 0 }}</div>
                <div class="text-muted">Tags únicas</div>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <a href="{{ url_for('knowledge_base.list') }}" class="btn btn-light shadow-sm" style="border-radius: 8px; padding: 0.5rem 1.5rem;">
            <i class="bi bi-arrow-right-circle"></i> Acessar Base de Conhecimento
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- Chart.js sem SRI para evitar bloqueio por hash incorreto -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const casesByStatus = {{ cases_by_status|default ({}) | tojson
  }};
  const casesByType = {{ cases_by_type|default ({}) | tojson }};
  const casesByMonth = {{ cases_by_month|default ({}) | tojson }};

  // Helper to transform dict into labels/data arrays
  const toSeries = (obj, labelMap) => {
    const labels = [];
    const data = [];
    Object.entries(obj || {}).forEach(([key, value]) => {
      labels.push(labelMap?.[key] || key);
      data.push(value);
    });
    return { labels, data };
  };

  const statusMap = {
    active: 'Ativos',
    draft: 'Rascunhos',
    filed: 'Protocolados',
  };

  const typeMap = {
    fap_trajeto: 'FAP Trajeto',
    fap_nexo: 'FAP Nexo',
    fap_multiplos: 'FAP Múltiplos',
    auto_infracao: 'Auto Infração',
  };

  const palette = ['#0d6efd', '#198754', '#ffc107', '#0dcaf0', '#6610f2', '#fd7e14', '#6c757d'];

  // Monthly chart
  if (Object.keys(casesByMonth).length) {
    const { labels, data } = toSeries(casesByMonth);
    const ctx = document.getElementById('chartMonthly');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Casos abertos',
            data,
            borderColor: palette[0],
            backgroundColor: palette[0] + '33',
            tension: 0.25,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
          }],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        },
      });
    }
  }

  // Status chart
  if (Object.keys(casesByStatus).length) {
    const { labels, data } = toSeries(casesByStatus, statusMap);
    const ctx = document.getElementById('chartStatus');
    if (ctx) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Casos',
            data,
            backgroundColor: labels.map((_, i) => palette[i % palette.length]),
            borderRadius: 6,
          }],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        },
      });
    }
  }

  // Type chart
  if (Object.keys(casesByType).length) {
    const { labels, data } = toSeries(casesByType, typeMap);
    const ctx = document.getElementById('chartType');
    if (ctx) {
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: labels.map((_, i) => palette[i % palette.length]),
          }],
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
        },
      });
    }
  }
    });
</script>
{% endblock %}