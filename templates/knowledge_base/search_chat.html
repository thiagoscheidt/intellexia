{% extends "layout/base.html" %}

{% block title %}Pesquisar na Base de Conhecimento - IntellexIA{% endblock %}

{% block content %}
<div class="app-content-header"
  style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem 0; margin-bottom: 0.75rem; border-radius: 0 0 15px 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-sm-8">
        <div class="d-flex align-items-center">
          <div class="me-3">
            <div class="rounded-circle bg-white d-flex align-items-center justify-content-center"
              style="width: 40px; height: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
              <i class="bi bi-search" style="font-size: 1.2rem; color: #667eea;"></i>
            </div>
          </div>
          <div class="text-white">
            <h3 class="mb-0" style="font-weight: 600; font-size: 1.2rem;">
              <i class="bi bi-chat-dots-fill"></i> Pesquisar na Base de Conhecimento
            </h3>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <ol class="breadcrumb float-sm-end mb-0"
          style="background: rgba(255,255,255,0.15); padding: 0.5rem 0.75rem; border-radius: 10px; backdrop-filter: blur(10px);">
          <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}"
              class="text-white text-decoration-none"><i class="bi bi-house-fill"></i> Home</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('knowledge_base.list') }}"
              class="text-white text-decoration-none">Base de Conhecimento</a></li>
          <li class="breadcrumb-item active text-white" aria-current="page"><strong>Pesquisar</strong></li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid" style="height: calc(100vh - 90px);">
    <div class="row h-100">
      <div class="col-12 h-100">
        <div class="card h-100" id="knowledge-chat-card" style="display: flex; flex-direction: column;">
          <div class="card-header text-white"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 0.5rem 1rem;">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="d-flex align-items-center">
                  <div class="me-2">
                    <div class="rounded-circle bg-white d-flex align-items-center justify-content-center"
                      style="width: 30px; height: 30px;">
                      <i class="bi bi-robot" style="font-size: 1.1rem; color: #667eea;"></i>
                    </div>
                  </div>
                  <div>
                    <h3 class="mb-0" style="font-weight: 600; font-size: 1rem;">
                      Assistente Jur√≠dico IA
                    </h3>
                  </div>
                </div>
              </div>
              <div class="col-md-4 text-md-end">
                <span class="badge bg-white text-dark d-inline-flex align-items-center gap-2"
                  style="padding: 0.25rem 0.6rem; font-size: 0.8rem;">
                  <i class="bi bi-folder-fill text-primary"></i>
                  <strong>{{ total_documents }}</strong> documento(s)
                </span>
              </div>
            </div>
          </div>
          <div class="card-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0;">

            <!-- Chat Container -->
            <div id="chat-container" class="p-4"
              style="flex: 1; overflow-y: auto; overflow-x: hidden; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%); display: flex; align-items: center; justify-content: center;">
              <div id="chat-messages" style="width: 100%; max-width: 900px;">
                <div class="text-center py-3">
                  <div class="mb-4">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                      style="width: 100px; height: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                      <i class="bi bi-chat-dots-fill text-white" style="font-size: 3rem;"></i>
                    </div>
                  </div>
                  <h3 class="mb-3" style="font-weight: 600; color: #2d3748;">
                    Ol√°! Sou seu Assistente Jur√≠dico
                  </h3>
                  <p class="text-muted mb-4" style="font-size: 1.1rem; max-width: 500px; margin: 0 auto;">
                    Posso ajud√°-lo a encontrar informa√ß√µes nos seus documentos da base de conhecimento
                  </p>

                  <div class="row justify-content-center mt-5">
                    <div class="col-md-8">
                      <div class="row g-3">
                        <div class="col-md-4">
                          <div class="card border-0 shadow-sm h-100" style="transition: transform 0.2s;">
                            <div class="card-body text-center p-3">
                              <i class="bi bi-lightning-charge-fill text-primary mb-2" style="font-size: 2rem;"></i>
                              <h6 class="mb-1">R√°pido</h6>
                              <small class="text-muted">Respostas instant√¢neas</small>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="card border-0 shadow-sm h-100" style="transition: transform 0.2s;">
                            <div class="card-body text-center p-3">
                              <i class="bi bi-shield-check text-success mb-2" style="font-size: 2rem;"></i>
                              <h6 class="mb-1">Confi√°vel</h6>
                              <small class="text-muted">Baseado em seus docs</small>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="card border-0 shadow-sm h-100" style="transition: transform 0.2s;">
                            <div class="card-body text-center p-3">
                              <i class="bi bi-book text-info mb-2" style="font-size: 2rem;"></i>
                              <h6 class="mb-1">Completo</h6>
                              <small class="text-muted">Com fontes citadas</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="mt-5">
                    <small class="text-muted d-block mb-2">
                      <i class="bi bi-lightbulb-fill text-warning"></i> <strong>Dica:</strong> Seja espec√≠fico nas suas
                      perguntas
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Input Area -->
            <div class="border-top bg-white p-4" style="flex-shrink: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">
              <!-- Exemplos de perguntas - acima do input -->
              <div class="mb-3">
                <small class="text-muted d-block mb-2">
                  <i class="bi bi-stars"></i> <strong>Perguntas sugeridas:</strong>
                </small>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-outline-primary example-question"
                    data-question="Qual o prazo para contesta√ß√£o do FAP?" style="border-radius: 20px;">
                    <i class="bi bi-lightning-fill"></i> Prazo contesta√ß√£o FAP
                  </button>
                  <button class="btn btn-sm btn-outline-primary example-question"
                    data-question="Como funciona o c√°lculo do FAP?" style="border-radius: 20px;">
                    <i class="bi bi-calculator-fill"></i> C√°lculo do FAP
                  </button>
                  <button class="btn btn-sm btn-outline-primary example-question"
                    data-question="O que √© acidente de trajeto?" style="border-radius: 20px;">
                    <i class="bi bi-question-circle-fill"></i> Acidente de trajeto
                  </button>
                </div>
              </div>

              <form id="question-form">
                <div class="input-group input-group-lg shadow-sm">
                  <input type="text" class="form-control border-0" id="question-input"
                    placeholder="Digite sua pergunta aqui..." autocomplete="off" required
                    style="border-radius: 30px 0 0 30px; padding-left: 25px; background: #f8f9fa;">
                  <button class="btn btn-primary px-4" type="submit" id="send-btn"
                    style="border-radius: 0 30px 30px 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    <i class="bi bi-send-fill"></i> Enviar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Escopar TODOS os estilos apenas para este card espec√≠fico */
  #knowledge-chat-card .message {
    margin-bottom: 20px;
    animation: kb-fadeIn 0.4s ease-out;
    clear: both;
  }

  @keyframes kb-fadeIn {
    from {
      opacity: 0;
      transform: translateY(15px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #knowledge-chat-card .message-user {
    text-align: right;
  }

  #knowledge-chat-card .message-user .message-content {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    display: inline-block;
    padding: 12px 18px;
    border-radius: 20px 20px 4px 20px;
    max-width: 75%;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    font-size: 0.95rem;
    line-height: 1.5;
  }

  #knowledge-chat-card .message-assistant {
    text-align: left;
  }

  #knowledge-chat-card .message-assistant .message-content {
    background: white;
    border: 2px solid #e9ecef;
    display: inline-block;
    padding: 12px 18px;
    border-radius: 20px 20px 20px 4px;
    max-width: 75%;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    font-size: 0.95rem;
    line-height: 1.6;
  }

  #knowledge-chat-card .message-loading {
    text-align: left;
  }

  #knowledge-chat-card .message-loading .message-content {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    display: inline-block;
    padding: 12px 18px;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  #knowledge-chat-card .sources {
    margin-top: 12px;
    padding: 12px 15px;
    background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 100%);
    border-left: 4px solid #007bff;
    border-radius: 8px;
    font-size: 0.85rem;
  }

  #knowledge-chat-card .sources-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #knowledge-chat-card .source-item {
    color: #6c757d;
    margin-left: 15px;
    padding: 4px 0;
    font-size: 0.85rem;
  }

  #knowledge-chat-card .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  #knowledge-chat-card .typing-indicator span {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    animation: kb-typing 1.4s infinite ease-in-out;
  }

  #knowledge-chat-card .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  #knowledge-chat-card .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes kb-typing {

    0%,
    60%,
    100% {
      transform: translateY(0);
      opacity: 0.7;
    }

    30% {
      transform: translateY(-12px);
      opacity: 1;
    }
  }

  /* Estilo para o input */
  #knowledge-chat-card #question-input:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  #knowledge-chat-card .example-question {
    transition: all 0.2s ease;
    border-radius: 20px;
  }

  #knowledge-chat-card .example-question:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
  }

  /* Scrollbar personalizada */
  #knowledge-chat-card #chat-container::-webkit-scrollbar {
    width: 8px;
  }

  #knowledge-chat-card #chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  #knowledge-chat-card #chat-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }

  #knowledge-chat-card #chat-container::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Estilos para markdown renderizado */
  #knowledge-chat-card .message-content h1,
  #knowledge-chat-card .message-content h2,
  #knowledge-chat-card .message-content h3,
  #knowledge-chat-card .message-content h4 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  #knowledge-chat-card .message-content h1 {
    font-size: 1.5rem;
  }

  #knowledge-chat-card .message-content h2 {
    font-size: 1.3rem;
  }

  #knowledge-chat-card .message-content h3 {
    font-size: 1.1rem;
  }

  #knowledge-chat-card .message-content p {
    margin-bottom: 0.75rem;
  }

  #knowledge-chat-card .message-content ul,
  #knowledge-chat-card .message-content ol {
    margin-left: 1.5rem;
    margin-bottom: 0.75rem;
  }

  #knowledge-chat-card .message-content li {
    margin-bottom: 0.25rem;
  }

  #knowledge-chat-card .message-content code {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }

  #knowledge-chat-card .message-content pre {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 1rem;
    overflow-x: auto;
    margin-bottom: 0.75rem;
  }

  #knowledge-chat-card .message-content pre code {
    background-color: transparent;
    padding: 0;
  }

  #knowledge-chat-card .message-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin-left: 0;
    color: #6c757d;
    font-style: italic;
  }

  #knowledge-chat-card .message-content strong {
    font-weight: 600;
  }

  #knowledge-chat-card .message-content a {
    color: #007bff;
    text-decoration: underline;
  }

  #knowledge-chat-card .message-content a:hover {
    color: #0056b3;
  }
</style>

<!-- Modal para Resumo -->
<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h5 class="modal-title" id="summaryModalLabel">
          <i class="bi bi-file-text"></i> Resumo do Documento
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="summaryContent">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="mt-3 text-muted">Carregando resumo...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Biblioteca para renderizar Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Configurar marked.js
    if (typeof marked !== 'undefined') {
      marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: false,
        smartLists: true,
        smartypants: true
      });
    }
    const questionForm = document.getElementById('question-form');
    const questionInput = document.getElementById('question-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatContainer = document.getElementById('chat-container');
    const exampleButtons = document.querySelectorAll('.example-question');

    // Hist√≥rico da conversa (formato OpenAI: [{role, content}])
    let conversationHistory = [];

    // Limpar mensagem inicial quando come√ßar a conversa
    let isFirstMessage = true;

    // Carregar hist√≥rico ao abrir a p√°gina
    async function loadHistory() {
      try {
        const response = await fetch('{{ url_for("knowledge_base.api_history") }}');
        const data = await response.json();

        if (data.success && data.history && data.history.length > 0) {
          // Limpar tela inicial
          isFirstMessage = false;
          chatMessages.innerHTML = '';
          chatMessages.style.maxWidth = 'none';
          chatContainer.style.display = 'block';
          chatContainer.style.alignItems = 'flex-start';
          chatContainer.style.justifyContent = 'flex-start';

          // Renderizar mensagens do hist√≥rico
          data.history.forEach(entry => {
            // Adicionar pergunta do usu√°rio
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'message message-user';
            userMsgDiv.innerHTML = `
              <div class="message-content">
                <strong>Voc√™:</strong><br>
                ${escapeHtml(entry.question)}
              </div>
            `;
            chatMessages.appendChild(userMsgDiv);

            // Adicionar resposta do assistente
            const assistantMsgDiv = document.createElement('div');
            assistantMsgDiv.className = 'message message-assistant';

            let sourcesHtml = '';
            if (entry.sources && entry.sources.length > 0) {
              sourcesHtml = `
                <div class="sources">
                  <div class="sources-title"><i class="bi bi-book"></i> Fontes:</div>
                  ${entry.sources.map(source => `<div class="source-item">‚Ä¢ ${escapeHtml(source)}</div>`).join('')}
                </div>
              `;
            }

            let renderedAnswer = entry.answer;
            if (typeof marked !== 'undefined') {
              try {
                renderedAnswer = marked.parse(entry.answer);
              } catch (error) {
                renderedAnswer = escapeHtml(entry.answer);
              }
            } else {
              renderedAnswer = escapeHtml(entry.answer);
            }

            assistantMsgDiv.innerHTML = `
              <div class="message-content">
                <strong><i class="bi bi-robot"></i> Assistente:</strong><br>
                <div class="markdown-content">${renderedAnswer}</div>
                ${sourcesHtml}
              </div>
            `;
            chatMessages.appendChild(assistantMsgDiv);

            // Adicionar ao hist√≥rico da conversa
            conversationHistory.push({ role: 'user', content: entry.question });
            conversationHistory.push({ role: 'assistant', content: entry.answer });
          });

          scrollToBottom();
        }
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
      }
    }

    // Fun√ß√£o para adicionar mensagem do usu√°rio
    function addUserMessage(text) {
      if (isFirstMessage) {
        chatMessages.innerHTML = '';
        chatMessages.style.maxWidth = 'none';
        chatContainer.style.display = 'block';
        chatContainer.style.alignItems = 'flex-start';
        chatContainer.style.justifyContent = 'flex-start';
        isFirstMessage = false;
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-user';
      messageDiv.innerHTML = `
        <div class="message-content">
          <strong>Voc√™:</strong><br>
          ${escapeHtml(text)}
        </div>
      `;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    // Fun√ß√£o para adicionar mensagem de carregamento
    function addLoadingMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-loading';
      messageDiv.id = 'loading-message';
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="ms-2 text-muted">IA pesquisando...</span>
        </div>
      `;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    // Fun√ß√£o para remover mensagem de carregamento
    function removeLoadingMessage() {
      const loadingMsg = document.getElementById('loading-message');
      if (loadingMsg) {
        loadingMsg.remove();
      }
    }

    // Fun√ß√£o para adicionar resposta do assistente
    function addAssistantMessage(answer, sources, sourcesDetail) {
      removeLoadingMessage();

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-assistant';

      let sourcesHtml = '';
      if (sourcesDetail && sourcesDetail.length > 0) {
        // Agrupa fontes pelo arquivo
        const sourcesByFile = {};
        sourcesDetail.forEach(detail => {
          if (!sourcesByFile[detail.source]) {
            sourcesByFile[detail.source] = [];
          }
          if (detail.page && !sourcesByFile[detail.source].includes(detail.page)) {
            sourcesByFile[detail.source].push(detail.page);
          }
        });

        const sourceItems = Object.entries(sourcesByFile).map(([fileName, pages]) => {
          const pageInfo = pages.length > 0 ? ` (P√°g. ${pages.sort((a, b) => a - b).join(', ')})` : '';

          // Busca o file_id da primeira ocorr√™ncia deste arquivo
          const fileDetail = sourcesDetail.find(d => d.source === fileName);
          const fileId = fileDetail && fileDetail.file_id ? fileDetail.file_id : null;
          const fileType = fileDetail && fileDetail.file_type ? String(fileDetail.file_type).toUpperCase() : '';
          const fileExt = fileName.split('.').pop().toLowerCase();

          // Se temos file_id, usa rota por ID, sen√£o usa por nome
          const downloadUrl = fileId
            ? `/knowledge-base/${fileId}/download`
            : `{{ url_for('knowledge_base.download_by_name') }}?filename=${encodeURIComponent(fileName)}`;

          let viewUrl = null;
          if (fileId) {
            if (fileType === 'PDF' || fileExt === 'pdf') {
              viewUrl = `/knowledge-base/${fileId}/view`;
            } else if (fileType === 'DOCX' || fileExt === 'docx') {
              viewUrl = `/knowledge-base/${fileId}/view-docx`;
            }
          }

          return `
            <div class="source-item d-flex justify-content-between align-items-center" style="padding: 0.5rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: 8px;">
              <span>
                <i class="bi bi-file-earmark-text"></i> ${escapeHtml(fileName)}${pageInfo}
              </span>
              <div class="d-flex gap-2">
                 ${fileId ? `
                 <button class="btn btn-sm btn-success shadow summary-btn"
                   data-file-id="${fileId}"
                   style="padding: 0.25rem 0.75rem; font-size: 0.875rem; text-decoration: none; color: white; border-radius: 8px; border: none; cursor: pointer;">
                  <i class="bi bi-file-text"></i> Resumo
                 </button>
                 ` : ''}
                 ${viewUrl ? `
                 <a href="${viewUrl}" 
                   class="btn btn-sm btn-info shadow"
                   target="_blank"
                   style="padding: 0.25rem 0.75rem; font-size: 0.875rem; text-decoration: none; color: white; border-radius: 8px;">
                  <i class="bi bi-eye"></i> Visualizar
                 </a>
                 ` : ''}
                <a href="${downloadUrl}" 
                   class="btn btn-sm btn-primary shadow"
                   target="_blank"
                   style="padding: 0.25rem 0.75rem; font-size: 0.875rem; text-decoration: none; color: white; border-radius: 8px;">
                  <i class="bi bi-download"></i> Baixar
                </a>
              </div>
            </div>
          `;
        }).join('');

        sourcesHtml = `
          <div class="sources" style="margin-top: 1rem; padding: 1rem; background: #f0f4ff; border-radius: 10px; border-left: 4px solid #667eea;">
            <div class="sources-title" style="font-weight: 600; margin-bottom: 0.75rem; color: #667eea;">
              <i class="bi bi-book"></i> Fontes Utilizadas:
            </div>
            ${sourceItems}
          </div>
        `;
      } else if (sources && sources.length > 0) {
        // Fallback para formato antigo
        sourcesHtml = `
          <div class="sources">
            <div class="sources-title"><i class="bi bi-book"></i> Fontes:</div>
            ${sources.map(source => `<div class="source-item">‚Ä¢ ${escapeHtml(source)}</div>`).join('')}
          </div>
        `;
      }

      // Renderizar markdown se a biblioteca marked estiver dispon√≠vel
      let renderedAnswer = answer;
      if (typeof marked !== 'undefined') {
        try {
          renderedAnswer = marked.parse(answer);
        } catch (error) {
          console.error('Erro ao renderizar markdown:', error);
          renderedAnswer = escapeHtml(answer);
        }
      } else {
        renderedAnswer = escapeHtml(answer);
      }

      messageDiv.innerHTML = `
        <div class="message-content">
          <strong><i class="bi bi-robot"></i> Assistente:</strong><br>
          <div class="markdown-content">${renderedAnswer}</div>
          ${sourcesHtml}
        </div>
      `;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    // Fun√ß√£o para adicionar mensagem de erro
    function addErrorMessage(error) {
      removeLoadingMessage();

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-assistant';
      messageDiv.innerHTML = `
        <div class="message-content">
          <strong><i class="bi bi-exclamation-triangle text-danger"></i> Erro:</strong><br>
          ${escapeHtml(error)}
        </div>
      `;
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
    }

    // Fun√ß√£o para rolar para o final
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Fun√ß√£o para escapar HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Enviar pergunta
    async function sendQuestion(question) {
      if (!question.trim()) return;

      // Adicionar mensagem do usu√°rio
      addUserMessage(question);

      // Adicionar ao hist√≥rico da conversa
      conversationHistory.push({ role: 'user', content: question });

      // Limpar input
      questionInput.value = '';

      // Desabilitar bot√£o e input
      sendBtn.disabled = true;
      questionInput.disabled = true;

      // Adicionar indicador de carregamento
      addLoadingMessage();

      try {
        const response = await fetch('{{ url_for("knowledge_base.api_ask") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            question: question,
            history: conversationHistory
          })
        });

        const data = await response.json();

        if (data.success) {
          addAssistantMessage(data.answer, data.sources, data.sources_detail);
          // Adicionar resposta ao hist√≥rico
          conversationHistory.push({ role: 'assistant', content: data.answer });
        } else {
          addErrorMessage(data.error || 'Erro ao processar sua pergunta');
        }
      } catch (error) {
        console.error('Erro:', error);
        addErrorMessage('Erro ao conectar com o servidor. Tente novamente.');
      } finally {
        // Reabilitar bot√£o e input
        sendBtn.disabled = false;
        questionInput.disabled = false;
        questionInput.focus();
      }
    }

    // Event listener para o formul√°rio
    questionForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const question = questionInput.value.trim();
      if (question) {
        sendQuestion(question);
      }
    });

    // Event listeners para perguntas de exemplo
    exampleButtons.forEach(button => {
      button.addEventListener('click', function () {
        const question = this.getAttribute('data-question');
        questionInput.value = question;
        sendQuestion(question);
      });
    });

    // Carregar hist√≥rico ao inicializar
    loadHistory();

    // Focar no input ao carregar
    questionInput.focus();

    // EVENT LISTENERS PARA BOT√ïES DE RESUMO
    document.addEventListener('click', async function(e) {
      if (e.target.closest('.summary-btn')) {
        const btn = e.target.closest('.summary-btn');
        const fileId = btn.getAttribute('data-file-id');
        
        if (!fileId) return;
        
        // Abrir modal
        const summaryModal = new bootstrap.Modal(document.getElementById('summaryModal'));
        summaryModal.show();
        
        // Carregar resumo
        try {
          const response = await fetch(`/knowledge-base/${fileId}/get-summary`);
          const data = await response.json();
          
          const summaryContent = document.getElementById('summaryContent');
          
          if (data.success && data.summary) {
            const summary = data.summary.payload || {};
            
            let htmlContent = '';
            
            // T√≠tulo do documento
            if (summary.document_name) {
              htmlContent += `<h5 class="mb-3" style="color: #667eea; font-weight: 600;">üìÑ ${escapeHtml(summary.document_name)}</h5>`;
            }
            
            // Resumo Curto
            if (summary.summary_short) {
              htmlContent += `
                <div class="alert alert-light border-start border-4" style="border-color: #667eea; background: #f8f9ff;">
                  <h6 class="mb-2" style="font-weight: 600; color: #667eea;">
                    <i class="bi bi-lightning-fill"></i> Resumo Curto
                  </h6>
                  <p class="mb-0 small">${escapeHtml(summary.summary_short)}</p>
                </div>
              `;
            }
            
            // Resumo Longo
            if (summary.summary_long) {
              htmlContent += `
                <div class="card mb-3 border-0 bg-light">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #667eea;">
                    <h6 class="mb-0" style="font-weight: 600; color: #667eea;">
                      <i class="bi bi-star-fill"></i> Resumo Completo
                    </h6>
                  </div>
                  <div class="card-body small" style="line-height: 1.6; white-space: pre-wrap;">
                    ${escapeHtml(summary.summary_long)}
                  </div>
                </div>
              `;
            }
            
            // Informa√ß√µes Processuais (lawsuit_info)
            if (summary.lawsuit_info && Object.keys(summary.lawsuit_info).some(k => summary.lawsuit_info[k])) {
              const lawsuit = summary.lawsuit_info;
              let lawsuitHtml = `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #dc3545;">
                    <h6 class="mb-0" style="font-weight: 600; color: #dc3545;">
                      <i class="bi bi-briefcase-fill"></i> Informa√ß√µes Processuais
                    </h6>
                  </div>
                  <div class="card-body small">
              `;
              
              // Dados b√°sicos do processo
              if (lawsuit.process_number) {
                lawsuitHtml += `<div class="mb-2"><strong>N√∫mero do Processo:</strong> <code style="background: #f0f0f0; padding: 0.25rem 0.5rem; border-radius: 4px;">${escapeHtml(lawsuit.process_number)}</code></div>`;
              }
              if (lawsuit.case_value) {
                lawsuitHtml += `<div class="mb-2"><strong>Valor da Causa:</strong> ${escapeHtml(lawsuit.case_value)}</div>`;
              }
              if (lawsuit.start_year) {
                lawsuitHtml += `<div class="mb-2"><strong>Ano de In√≠cio:</strong> ${escapeHtml(lawsuit.start_year)}</div>`;
              }
              if (lawsuit.nature) {
                lawsuitHtml += `<div class="mb-2"><strong>Natureza:</strong> ${escapeHtml(lawsuit.nature)}</div>`;
              }
              if (lawsuit.judicial_power) {
                lawsuitHtml += `<div class="mb-2"><strong>Poder Judici√°rio:</strong> ${escapeHtml(lawsuit.judicial_power)}</div>`;
              }
              if (lawsuit.origin_court) {
                lawsuitHtml += `<div class="mb-2"><strong>Tribunal de Origem:</strong> ${escapeHtml(lawsuit.origin_court)}</div>`;
              }
              if (lawsuit.court_tag) {
                lawsuitHtml += `<div class="mb-2"><strong>Tribunal:</strong> <span class="badge bg-primary">${escapeHtml(lawsuit.court_tag)}</span></div>`;
              }
              if (lawsuit.judge) {
                lawsuitHtml += `<div class="mb-2"><strong>Juiz:</strong> ${escapeHtml(lawsuit.judge)}</div>`;
              }
              
              // Assuntos
              if (lawsuit.subjects && Array.isArray(lawsuit.subjects) && lawsuit.subjects.length > 0) {
                lawsuitHtml += `
                  <div class="mb-3">
                    <strong>Assuntos:</strong><br>
                    <div class="d-flex flex-wrap gap-1 mt-2">
                      ${lawsuit.subjects.map(s => `<span class="badge bg-warning text-dark">${escapeHtml(s)}</span>`).join('')}
                    </div>
                  </div>
                `;
              }
              
              // Polos Processuais
              if (lawsuit.parties) {
                // Polo Ativo
                if (lawsuit.parties.active_pole && Array.isArray(lawsuit.parties.active_pole) && lawsuit.parties.active_pole.length > 0) {
                  lawsuitHtml += `
                    <div class="mt-3 pt-3 border-top">
                      <strong style="color: #28a745;">
                        <i class="bi bi-arrow-up-circle"></i> Polo Ativo
                      </strong>
                      <ul class="mb-2 mt-2" style="padding-left: 1.5rem;">
                  `;
                  lawsuit.parties.active_pole.forEach(part => {
                    let partHtml = `<li>${escapeHtml(part.name)}`;
                    if (part.role) partHtml += ` <small class="text-muted">(${escapeHtml(part.role)})</small>`;
                    if (part.lawyers && Array.isArray(part.lawyers) && part.lawyers.length > 0) {
                      partHtml += `<ul style="margin-top: 0.5rem; margin-bottom: 0.5rem; padding-left: 1rem;">`;
                      part.lawyers.forEach(lawyer => {
                        partHtml += `<li><small>‚öñÔ∏è ${escapeHtml(lawyer)}</small></li>`;
                      });
                      partHtml += `</ul>`;
                    }
                    partHtml += `</li>`;
                    lawsuitHtml += partHtml;
                  });
                  lawsuitHtml += `</ul></div>`;
                }
                
                // Polo Passivo
                if (lawsuit.parties.passive_pole && Array.isArray(lawsuit.parties.passive_pole) && lawsuit.parties.passive_pole.length > 0) {
                  lawsuitHtml += `
                    <div class="mt-2 pt-3 border-top">
                      <strong style="color: #dc3545;">
                        <i class="bi bi-arrow-down-circle"></i> Polo Passivo
                      </strong>
                      <ul class="mb-0 mt-2" style="padding-left: 1.5rem;">
                  `;
                  lawsuit.parties.passive_pole.forEach(part => {
                    let partHtml = `<li>${escapeHtml(part.name)}`;
                    if (part.role) partHtml += ` <small class="text-muted">(${escapeHtml(part.role)})</small>`;
                    if (part.lawyers && Array.isArray(part.lawyers) && part.lawyers.length > 0) {
                      partHtml += `<ul style="margin-top: 0.5rem; margin-bottom: 0.5rem; padding-left: 1rem;">`;
                      part.lawyers.forEach(lawyer => {
                        partHtml += `<li><small>‚öñÔ∏è ${escapeHtml(lawyer)}</small></li>`;
                      });
                      partHtml += `</ul>`;
                    }
                    partHtml += `</li>`;
                    lawsuitHtml += partHtml;
                  });
                  lawsuitHtml += `</ul></div>`;
                }
              }
              
              lawsuitHtml += `</div></div>`;
              htmlContent += lawsuitHtml;
            }
            
            // Principais Pontos
            if (summary.key_points && summary.key_points.length > 0) {
              htmlContent += `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #28a745;">
                    <h6 class="mb-0" style="font-weight: 600; color: #28a745;">
                      <i class="bi bi-check-circle-fill"></i> Pontos-Chave
                    </h6>
                  </div>
                  <div class="card-body small">
                    <ul class="mb-0">
              `;
              summary.key_points.forEach(point => {
                htmlContent += `<li class="mb-2">${escapeHtml(point)}</li>`;
              });
              htmlContent += `
                    </ul>
                  </div>
                </div>
              `;
            }
            
            // Partes/Se√ß√µes do Documento
            if (summary.sections && summary.sections.length > 0) {
              htmlContent += `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #0d6efd;">
                    <h6 class="mb-0" style="font-weight: 600; color: #0d6efd;">
                      <i class="bi bi-list-ul"></i> Se√ß√µes do Documento
                    </h6>
                  </div>
                  <div class="card-body small">
                    <ul class="mb-0">
              `;
              summary.sections.forEach(section => {
                htmlContent += `<li class="mb-2">${escapeHtml(section)}</li>`;
              });
              htmlContent += `
                    </ul>
                  </div>
                </div>
              `;
            }
            
            // Partes (alternativa se chamado de "parts")
            if (summary.parts && summary.parts.length > 0) {
              htmlContent += `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #0d6efd;">
                    <h6 class="mb-0" style="font-weight: 600; color: #0d6efd;">
                      <i class="bi bi-bookmark-fill"></i> Partes
                    </h6>
                  </div>
                  <div class="card-body small">
                    <ul class="mb-0">
              `;
              summary.parts.forEach(part => {
                htmlContent += `<li class="mb-2">${escapeHtml(part)}</li>`;
              });
              htmlContent += `
                    </ul>
                  </div>
                </div>
              `;
            }
            
            // N√∫meros de Processo
            if (summary.lawsuit_numbers && summary.lawsuit_numbers.length > 0) {
              htmlContent += `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #ffc107;">
                    <h6 class="mb-0" style="font-weight: 600; color: #ff9800;">
                      <i class="bi bi-bookmark-fill"></i> N√∫meros de Processo
                    </h6>
                  </div>
                  <div class="card-body small">
                    <div class="d-flex flex-wrap gap-2">
              `;
              summary.lawsuit_numbers.forEach(num => {
                htmlContent += `<span class="badge bg-warning text-dark">${escapeHtml(num)}</span>`;
              });
              htmlContent += `
                    </div>
                  </div>
                </div>
              `;
            }
            
            // Datas Importantes
            if (summary.important_dates && Object.keys(summary.important_dates).length > 0) {
              htmlContent += `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #17a2b8;">
                    <h6 class="mb-0" style="font-weight: 600; color: #17a2b8;">
                      <i class="bi bi-calendar-event-fill"></i> Datas Importantes
                    </h6>
                  </div>
                  <div class="card-body small">
                    <table class="table table-sm table-borderless mb-0">
              `;
              Object.entries(summary.important_dates).forEach(([key, value]) => {
                htmlContent += `<tr><td class="fw-bold">${key}:</td><td>${escapeHtml(value)}</td></tr>`;
              });
              htmlContent += `
                    </table>
                  </div>
                </div>
              `;
            }
            
            // Documentos Relacionados
            if (summary.related_documents && summary.related_documents.length > 0) {
              htmlContent += `
                <div class="card mb-3 border-0">
                  <div class="card-header bg-light border-bottom-2" style="border-bottom: 2px solid #dc3545;">
                    <h6 class="mb-0" style="font-weight: 600; color: #dc3545;">
                      <i class="bi bi-link-45deg"></i> Documentos Relacionados
                    </h6>
                  </div>
                  <div class="card-body small">
                    <ul class="mb-0">
              `;
              summary.related_documents.forEach(doc => {
                htmlContent += `<li class="mb-2">${escapeHtml(doc)}</li>`;
              });
              htmlContent += `
                    </ul>
                  </div>
                </div>
              `;
            }
            
            // Conclus√£o
            if (summary.conclusion) {
              htmlContent += `
                <div class="alert alert-info border-0" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                  <h6 class="mb-2" style="font-weight: 600; color: #667eea;">
                    <i class="bi bi-info-circle-fill"></i> Conclus√£o
                  </h6>
                  <p class="mb-0 small">${summary.conclusion}</p>
                </div>
              `;
            }
            
            if (!htmlContent) {
              htmlContent = `<p class="text-muted text-center py-4"><i class="bi bi-inbox"></i> Nenhum resumo dispon√≠vel para este documento.</p>`;
            }
            
            summaryContent.innerHTML = htmlContent;
          } else {
            summaryContent.innerHTML = `
              <div class="alert alert-warning border-0 text-center">
                <i class="bi bi-exclamation-triangle"></i>
                <p class="mb-0">Resumo n√£o dispon√≠vel. <a href="/knowledge-base/${fileId}/generate-summary" class="alert-link">Gerar agora?</a></p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Erro ao carregar resumo:', error);
          document.getElementById('summaryContent').innerHTML = `
            <div class="alert alert-danger border-0">
              <i class="bi bi-exclamation-circle"></i> Erro ao carregar resumo.
            </div>
          `;
        }
      }
    });
  });
</script>
{% endblock %}