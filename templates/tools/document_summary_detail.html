{% extends "layout/base.html" %}

{% block title %}Detalhes do Documento - IntellexIA{% endblock %}

{% block content %}
<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0"><i class="bi bi-file-earmark-text"></i> Detalhes do Documento</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a href="{{ url_for('dashboard.dashboard') }}">Home</a></li>
          <li class="breadcrumb-item"><a href="#">Ferramentas</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('tools.tools_document_summary_list') }}">Resumo de Documentos</a></li>
          <li class="breadcrumb-item active" aria-current="page">Detalhes</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle"></i> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="row">
      <!-- Informações do Documento -->
      <div class="col-md-4">
        <div class="card card-primary card-outline">
          <div class="card-header">
            <h3 class="card-title"><i class="bi bi-info-circle"></i> Informações do Arquivo</h3>
          </div>
          <div class="card-body">
            <dl class="row">
              <dt class="col-sm-4">ID:</dt>
              <dd class="col-sm-8">{{ document.id }}</dd>

              <dt class="col-sm-4">Nome:</dt>
              <dd class="col-sm-8">{{ document.original_filename }}</dd>

              <dt class="col-sm-4">Tipo:</dt>
              <dd class="col-sm-8">
                <span class="badge bg-secondary">{{ document.file_type }}</span>
              </dd>

              <dt class="col-sm-4">Tamanho:</dt>
              <dd class="col-sm-8">
                {% if document.file_size %}
                  {% if document.file_size < 1024 %}
                    {{ document.file_size }} B
                  {% elif document.file_size < 1048576 %}
                    {{ "%.2f"|format(document.file_size / 1024) }} KB
                  {% else %}
                    {{ "%.2f"|format(document.file_size / 1048576) }} MB
                  {% endif %}
                {% else %}
                  -
                {% endif %}
              </dd>

              <dt class="col-sm-4">Upload:</dt>
              <dd class="col-sm-8">
                {{ document.uploaded_at.strftime('%d/%m/%Y %H:%M') if document.uploaded_at else '-' }}
              </dd>

              <dt class="col-sm-4">Status:</dt>
              <dd class="col-sm-8">
                {% if document.status == 'pending' %}
                  <span class="badge bg-warning">
                    <i class="bi bi-hourglass-split"></i> Pendente
                  </span>
                {% elif document.status == 'processing' %}
                  <span class="badge bg-info">
                    <i class="bi bi-arrow-repeat"></i> Processando
                  </span>
                {% elif document.status == 'completed' %}
                  <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i> Processado
                  </span>
                {% elif document.status == 'error' %}
                  <span class="badge bg-danger">
                    <i class="bi bi-exclamation-triangle"></i> Erro
                  </span>
                {% endif %}
              </dd>

              {% if document.processed_at %}
              <dt class="col-sm-4">Processado:</dt>
              <dd class="col-sm-8">
                {{ document.processed_at.strftime('%d/%m/%Y %H:%M') }}
              </dd>
              {% endif %}

              <dt class="col-sm-4">Enviado por:</dt>
              <dd class="col-sm-8">
                {{ document.user.name if document.user else 'Desconhecido' }}
              </dd>
            </dl>

            <hr>

            <div class="d-grid gap-2">
              <form method="POST" 
                    action="{{ url_for('tools.tools_document_summary_delete', document_id=document.id) }}" 
                    onsubmit="return confirm('Tem certeza que deseja excluir este documento?');">
                <button type="submit" class="btn btn-danger w-100">
                  <i class="bi bi-trash"></i> Excluir Documento
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Resumo da IA -->
      <div class="col-md-8">
        <div class="card card-success card-outline">
          <div class="card-header">
            <h3 class="card-title"><i class="bi bi-robot"></i> Resumo Gerado pela IA</h3>
          </div>
          <div class="card-body">
            {% if document.status == 'pending' %}
              <div class="alert alert-warning">
                <i class="bi bi-hourglass-split"></i>
                <strong>Aguardando Processamento</strong>
                <p class="mb-0 mt-2">
                  O documento foi enviado com sucesso e está na fila para processamento. 
                  O resumo será gerado em breve pela IA.
                </p>
              </div>
            {% elif document.status == 'processing' %}
              <div class="alert alert-info">
                <i class="bi bi-arrow-repeat"></i>
                <strong>Processando...</strong>
                <p class="mb-0 mt-2">
                  A IA está analisando o documento e gerando o resumo. 
                  Este processo pode levar alguns minutos.
                </p>
              </div>
            {% elif document.status == 'completed' %}
              {% if document.summary_text %}
                <div class="alert alert-success">
                  <i class="bi bi-check-circle"></i>
                  <strong>Resumo Concluído</strong>
                </div>
                <div class="summary-content p-3 bg-light rounded">
                  {{ document.summary_text|safe }}
                </div>
              {% else %}
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle"></i>
                  <strong>Resumo não disponível</strong>
                  <p class="mb-0 mt-2">
                    O documento foi processado, mas o resumo não foi gerado. 
                    Por favor, tente novamente.
                  </p>
                </div>
              {% endif %}
            {% elif document.status == 'error' %}
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro no Processamento</strong>
                {% if document.error_message %}
                  <p class="mb-0 mt-2">{{ document.error_message }}</p>
                {% else %}
                  <p class="mb-0 mt-2">
                    Ocorreu um erro ao processar o documento. 
                    Por favor, tente enviar novamente.
                  </p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-12">
        <a href="{{ url_for('tools.tools_document_summary_list') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Voltar para Lista
        </a>
      </div>
    </div>
  </div>
</div>

<style>
.summary-content {
  white-space: pre-wrap;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
}
</style>
{% endblock %}
